<!DOCTYPE html>

<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Ø§Ù„Ø§Ø®ÙˆØ§Ù† Ù„ØªÙ†ÙÙŠØ° ÙˆØ§Ø¬Ù‡Ø§Øª ğŸ‡®ğŸ‡¶</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<!-- Firebase compat (works on all browsers including Safari iOS) -->
<script>
  // Ø§Ø³ØªØ®Ø¯Ø§Ù… Firebase REST API Ø¨Ø¯ÙˆÙ† Ù…ÙƒØªØ¨Ø© Ø®Ø§Ø±Ø¬ÙŠØ© - ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª
  const FB_URL = "https://omar-ali-97d74-default-rtdb.firebaseio.com";

window.*fbSet = async (path, val) => {
try {
const cleanPath = path.replace(/[.#$[]]/g, â€™*â€™);
const url = FB_URL + â€˜/â€™ + cleanPath + â€˜.jsonâ€™;
const res = await fetch(url, {
method: â€˜PUTâ€™,
headers: {â€˜Content-Typeâ€™: â€˜application/jsonâ€™},
body: JSON.stringify(val)
});
const result = await res.json();
if (result && result.error) throw new Error(result.error);
localStorage.setItem(â€˜backup_â€™ + cleanPath.replace(///g,â€™_â€™), JSON.stringify(val));
return true;
} catch(e) {
console.error(â€˜Firebase save failed:â€™, e);
return false;
}
};

window.*fbGet = async (path) => {
try {
const cleanPath = path.replace(/[.#$[]]/g, â€™*â€™);
const url = FB_URL + â€˜/â€™ + cleanPath + â€˜.jsonâ€™;
const res = await fetch(url);
const result = await res.json();
if (result && result.error) throw new Error(result.error);
if (result !== null) localStorage.setItem(â€˜backup_â€™ + cleanPath.replace(///g,â€™*â€™), JSON.stringify(result));
return result;
} catch(e) {
console.error(â€˜Firebase read failed:â€™, e);
const local = localStorage.getItem(â€™backup*â€™ + path.replace(/[.#$[]/]/g,â€™_â€™));
return local ? JSON.parse(local) : null;
}
};

window._firebaseReady = true;
</script>

<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Segoe UI', Tahoma, Arial, sans-serif; background: #f0f4f8; direction: rtl; font-size: 15px; }

.header { background: #1565C0; color: white; padding: 12px 16px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 50; flex-wrap: wrap; gap: 8px; }
.header-title { font-size: 17px; font-weight: 700; }
.tabs { display: flex; gap: 6px; flex-wrap: wrap; }
.tab-btn { padding: 6px 14px; border-radius: 20px; border: none; font-size: 13px; font-weight: 600; cursor: pointer; font-family: inherit; }
.tab-btn.active { background: white; color: #1565C0; }
.tab-btn:not(.active) { background: rgba(255,255,255,0.2); color: white; }
.sync-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-left: 5px; }
.sync-label { font-size: 12px; padding: 3px 10px; border-radius: 20px; font-weight: 600; display: flex; align-items: center; gap: 4px; white-space: nowrap; }
.sync-ok { background: #4caf50; color: white; }
.sync-pending { background: #ff9800; color: white; }
.sync-error { background: #f44336; color: white; }

.week-bar { background: white; padding: 10px 16px; display: flex; align-items: center; justify-content: space-between; border-bottom: 2px solid #e0e0e0; flex-wrap: wrap; gap: 8px; }
.week-label { background: white; border: 2px solid #1565C0; color: #1565C0; font-weight: 700; padding: 6px 14px; border-radius: 8px; font-size: 14px; font-family: inherit; }
.week-actions { display: flex; gap: 6px; flex-wrap: wrap; }
.btn { padding: 7px 14px; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; font-family: inherit; display: inline-flex; align-items: center; gap: 4px; transition: opacity .15s; }
.btn:active { opacity: .75; }
.btn-blue { background: #1565C0; color: white; }
.btn-red { background: #e53935; color: white; }
.btn-green { background: #2e7d32; color: white; }
.btn-orange { background: #e65100; color: white; }
.btn-teal { background: #00695c; color: white; }
.btn-gray { background: #607d8b; color: white; }
.btn-excel { background: #217346; color: white; }
.btn-purple { background: #6a1b9a; color: white; }

.content { padding: 14px; max-width: 700px; margin: 0 auto; }
.card { background: white; border-radius: 14px; margin-bottom: 14px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,.08); }
.card-header { padding: 12px 16px; font-size: 16px; font-weight: 700; display: flex; align-items: center; justify-content: space-between; color: white; }
.card-header.green { background: #2e7d32; }
.card-header.orange { background: #e65100; }
.card-header.red { background: #c62828; }
.card-header.purple { background: #6a1b9a; }
.card-body { padding: 14px 16px; }
.amount-badge { background: rgba(255,255,255,0.25); padding: 4px 12px; border-radius: 20px; font-size: 14px; }

.form-row { display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; }
.form-row input, .form-row select { flex: 1; min-width: 100px; padding: 9px 12px; border: 1.5px solid #ccc; border-radius: 8px; font-size: 14px; font-family: inherit; direction: rtl; outline: none; }
.form-row input:focus { border-color: #1565C0; }

.worker-card { background: #f8f9fa; border: 1.5px solid #e0e0e0; border-radius: 12px; margin-bottom: 12px; overflow: hidden; }
.worker-name-bar { background: #e3f2fd; padding: 10px 14px; font-size: 16px; font-weight: 700; color: #1565C0; display: flex; align-items: center; justify-content: space-between; }
.worker-body { padding: 12px 14px; }
.days-row { display: flex; gap: 6px; margin-bottom: 10px; flex-wrap: wrap; }
.day-btn { padding: 6px 10px; border-radius: 8px; border: none; font-size: 13px; font-weight: 600; cursor: pointer; font-family: inherit; background: #e53935; color: white; transition: background .15s; }
.day-btn.present { background: #2e7d32; }
.input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
.input-box { display: flex; flex-direction: column; gap: 3px; }
.input-box label { font-size: 11px; color: #666; font-weight: 600; }
.input-box input { padding: 8px 10px; border: 1.5px solid #ccc; border-radius: 8px; font-size: 14px; font-family: inherit; text-align: center; outline: none; }
.input-box input:focus { border-color: #1565C0; }
.final-salary { text-align: left; font-size: 16px; font-weight: 700; color: #2e7d32; margin-bottom: 10px; padding: 8px 10px; background: #e8f5e9; border-radius: 8px; }
.worker-actions { display: flex; gap: 6px; flex-wrap: wrap; }

.item-row { display: flex; align-items: center; padding: 8px 10px; background: #f5f5f5; border-radius: 8px; margin-bottom: 6px; font-size: 14px; gap: 8px; }
.item-info { flex: 1; }
.item-amount { font-weight: 700; }
.item-date { font-size: 12px; color: #888; }
.delete-btn { background: #e53935; color: white; border: none; border-radius: 6px; min-width: 28px; height: 28px; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.empty-msg { text-align: center; color: #aaa; padding: 16px; font-size: 14px; }

.summary-box { border-radius: 12px; padding: 14px 16px; margin-bottom: 10px; }
.summary-box.green { background: #e8f5e9; border: 2px solid #2e7d32; }
.summary-box.orange { background: #fff3e0; border: 2px solid #e65100; }
.summary-box.red { background: #ffebee; border: 2px solid #c62828; }
.summary-box.blue { background: #e3f2fd; border: 2px solid #1565C0; }
.summary-box.purple { background: #f3e5f5; border: 2px solid #6a1b9a; }
.summary-row { display: flex; justify-content: space-between; padding: 5px 0; font-size: 15px; border-bottom: 1px solid rgba(0,0,0,0.07); }
.summary-row:last-child { border-bottom: none; font-weight: 700; font-size: 16px; }
.summary-title { font-size: 16px; font-weight: 700; margin-bottom: 10px; }

.action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 14px; }
.action-btn-big { padding: 14px; border: none; border-radius: 12px; font-size: 15px; font-weight: 700; cursor: pointer; font-family: inherit; display: flex; flex-direction: column; align-items: center; gap: 6px; color: white; }
.action-btn-big .icon { font-size: 28px; }

.payment-item { background: #f3e5f5; border: 1.5px solid #ce93d8; border-radius: 10px; padding: 10px 14px; margin-bottom: 8px; display: flex; align-items: center; gap: 10px; }
.payment-item .p-amount { font-size: 18px; font-weight: 800; color: #6a1b9a; flex: 1; }
.payment-item .p-note { font-size: 13px; color: #555; }
.payment-item .p-date { font-size: 12px; color: #888; }

.loading-overlay { position: fixed; inset: 0; background: rgba(21,101,192,0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; z-index: 9999; gap: 16px; }
.loading-overlay.hidden { display: none; }
.spinner { width: 48px; height: 48px; border: 5px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin .8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

.session-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 9998; }
.session-modal.hidden { display: none; }
.session-box { background: white; border-radius: 16px; padding: 28px 24px; max-width: 360px; width: 92%; text-align: center; }
.session-box h2 { color: #1565C0; margin-bottom: 8px; font-size: 20px; }
.session-box p { color: #555; margin-bottom: 20px; font-size: 14px; line-height: 1.6; }
.session-box input { width: 100%; padding: 10px 14px; border: 2px solid #ccc; border-radius: 10px; font-size: 16px; font-family: inherit; direction: rtl; outline: none; margin-bottom: 12px; text-align: center; }
.session-box input:focus { border-color: #1565C0; }
.hint { font-size: 12px; color: #999; margin-top: 8px; }

.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 999; }
.modal-overlay.hidden { display: none; }
.modal-box { background: white; border-radius: 16px; padding: 24px; max-width: 380px; width: 92%; }
.modal-box h3 { color: #6a1b9a; margin-bottom: 16px; font-size: 18px; }
.modal-box input { width: 100%; padding: 10px 12px; border: 1.5px solid #ccc; border-radius: 8px; font-size: 14px; font-family: inherit; direction: rtl; outline: none; margin-bottom: 10px; }
.modal-box input:focus { border-color: #6a1b9a; }
.modal-actions { display: flex; gap: 8px; }
</style>

</head>
<body>

<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner"></div>
  <div style="font-size:18px;font-weight:700">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
  <div style="font-size:13px;opacity:.7">ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©</div>
</div>

<div class="session-modal hidden" id="sessionModal">
  <div class="session-box">
    <div style="font-size:44px;margin-bottom:8px">ğŸ‡®ğŸ‡¶</div>
    <h2>Ø§Ù„Ø§Ø®ÙˆØ§Ù† Ù„ØªÙ†ÙÙŠØ° ÙˆØ§Ø¬Ù‡Ø§Øª</h2>
    <p>Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§ØªÙƒ<br>Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù…Ù† Ø£ÙŠ Ø¬Ù‡Ø§Ø²</p>
    <input id="sessionInput" type="text" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø´Ø±ÙˆØ¹ Ø§Ø­Ù…Ø¯" maxlength="40">
    <button class="btn btn-blue" style="width:100%;justify-content:center;padding:12px;font-size:16px" onclick="startSession()">â† Ø¯Ø®ÙˆÙ„</button>
    <div class="hint">âš ï¸ Ø§Ø­ÙØ¸ Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… â€” Ø³ØªØ­ØªØ§Ø¬Ù‡ Ù„Ù„Ø¯Ø®ÙˆÙ„ Ù…Ù† Ø£Ø¬Ù‡Ø²Ø© Ø£Ø®Ø±Ù‰</div>
  </div>
</div>

<div class="modal-overlay hidden" id="paymentModal">
  <div class="modal-box">
    <h3>ğŸ’œ ØªØ³Ø¬ÙŠÙ„ Ù…Ø¨Ù„Øº Ù…Ø³ØªÙ„Ù…</h3>
    <input id="pmtAmount" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªÙ„Ù… (Ø¯ÙŠÙ†Ø§Ø±)">
    <input id="pmtDate" type="date">
    <input id="pmtNote" type="text" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
    <div class="modal-actions">
      <button class="btn btn-gray" onclick="closePaymentModal()" style="flex:1;justify-content:center">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn btn-purple" onclick="addPayment()" style="flex:2;justify-content:center">âœ… Ø­ÙØ¸ ÙˆØ¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„</button>
    </div>
  </div>
</div>

<div class="header">
  <div class="header-title">ğŸ‡®ğŸ‡¶ Ø§Ù„Ø§Ø®ÙˆØ§Ù† Ù„ØªÙ†ÙÙŠØ° ÙˆØ§Ø¬Ù‡Ø§Øª</div>
  <div class="tabs">
    <button class="tab-btn" onclick="showTab('workers')" id="tab-workers">ğŸ‘· Ø§Ù„Ø¹Ù…Ø§Ù„</button>
    <button class="tab-btn active" onclick="showTab('summary')" id="tab-summary">ğŸ“Œ Ø§Ù„Ù…Ù„Ø®Øµ</button>
    <button class="tab-btn" onclick="showTab('payments')" id="tab-payments">ğŸ’œ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„</button>
  </div>
  <span class="sync-label sync-ok" id="syncIndicator">â˜ï¸ Ù…Ø­ÙÙˆØ¸</span>
</div>

<div class="week-bar">
  <div class="week-actions">
    <button class="btn btn-blue" onclick="addWeek()">+ Ø£Ø³Ø¨ÙˆØ¹</button>
    <button class="btn btn-red" onclick="deleteCurrentWeek()">ğŸ—‘ï¸</button>
  </div>
  <select class="week-label" id="weekSelect" onchange="loadWeek()"></select>
</div>

<div class="content">
  <!-- WORKERS -->
  <div id="tab-workers-content" style="display:none">
    <div class="card">
      <div class="card-body">
        <div style="font-size:16px;font-weight:700;color:#1565C0;margin-bottom:10px">ğŸ‘· Ø¥Ø¶Ø§ÙØ© Ø¹Ø§Ù…Ù„ Ø¬Ø¯ÙŠØ¯</div>
        <div class="form-row">
          <input id="newWorkerName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„">
          <input id="newWorkerWage" type="number" placeholder="Ø§Ù„Ø£Ø¬Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ (Ø¯ÙŠÙ†Ø§Ø±)">
        </div>
        <div class="form-row">
          <input id="newWorkerPhone" placeholder="Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨">
          <button class="btn btn-green" onclick="addWorker()">Ø¥Ø¶Ø§ÙØ© âœ…</button>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-header red">
        <span>ğŸ’µ Ø³Ù„ÙØ© Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„</span>
        <span class="amount-badge" id="totalLoanBadge">0 Ø¯ÙŠÙ†Ø§Ø±</span>
      </div>
      <div class="card-body">
        <div class="form-row">
          <input id="loanAmount" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
          <input id="loanDate" type="date">
          <button class="btn btn-orange" onclick="addLoan()">Ø¥Ø¶Ø§ÙØ©</button>
        </div>
        <div id="loansList"></div>
      </div>
    </div>
    <div class="card">
      <div class="card-header orange">
        <span>ğŸ§¾ Ù…ØµØ±ÙˆÙ Ø£Ø³Ø¨ÙˆØ¹ÙŠ</span>
        <span class="amount-badge" id="totalExpBadge">0 Ø¯ÙŠÙ†Ø§Ø±</span>
      </div>
      <div class="card-body">
        <div class="form-row">
          <input id="expDesc" placeholder="ÙˆØµÙ Ø§Ù„Ù…ØµØ±ÙˆÙ">
          <input id="expAmount" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
        </div>
        <div class="form-row">
          <input id="expDate" type="date">
          <button class="btn btn-blue" onclick="addExpense()">Ø¥Ø¶Ø§ÙØ©</button>
        </div>
        <div id="expensesList"></div>
      </div>
    </div>
    <div id="workersList"></div>
  </div>

  <!-- SUMMARY -->

  <div id="tab-summary-content" style="display:block">
    <div id="summaryContent"></div>
  </div>

  <!-- PAYMENTS -->

  <div id="tab-payments-content" style="display:none">
    <div class="card">
      <div class="card-header purple">
        <span>ğŸ’œ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©</span>
        <span class="amount-badge" id="totalPaymentsBadge">0 Ø¯ÙŠÙ†Ø§Ø±</span>
      </div>
      <div class="card-body">
        <div style="margin-bottom:12px">
          <div style="font-size:13px;color:#666;margin-bottom:6px">ğŸ“± Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„:</div>
          <div class="form-row">
            <input id="contractorPhone" placeholder="Ù…Ø«Ø§Ù„: 213XXXXXXXXX" type="tel">
            <button class="btn btn-gray" onclick="saveContractorPhone()">Ø­ÙØ¸</button>
          </div>
        </div>
        <button class="btn btn-purple" style="width:100%;justify-content:center;padding:12px;margin-bottom:12px" onclick="openPaymentModal()">
          + ØªØ³Ø¬ÙŠÙ„ Ù…Ø¨Ù„Øº Ù…Ø³ØªÙ„Ù… ÙˆØ¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„
        </button>
        <div id="paymentsList"></div>
      </div>
    </div>
  </div>
</div>

<script>
const DAYS = ['Ø§Ù„Ø³Ø¨Øª','Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©'];
let sessionKey = '', currentWeek = '', data = {}, saveTimer = null;

// ===== FIREBASE SAVE/LOAD =====
function setSyncStatus(s) {
  const el = document.getElementById('syncIndicator');
  const m = { saving:['sync-pending','â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...'], ok:['sync-ok','â˜ï¸ Ù…Ø­ÙÙˆØ¸'], error:['sync-error','âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸'] };
  el.className = 'sync-label ' + m[s][0]; el.textContent = m[s][1];
}

function saveData() {
  setSyncStatus('saving');
  clearTimeout(saveTimer);
  saveTimer = setTimeout(async () => {
    try {
      await window._fbSet('projects/' + sessionKey, data);
      setSyncStatus('ok');
    } catch(e) {
      console.error(e);
      setSyncStatus('error');
      // fallback localStorage
      localStorage.setItem('fb_backup_'+sessionKey, JSON.stringify(data));
    }
  }, 700);
}

// ===== SESSION =====
function startSession() {
  const val = document.getElementById('sessionInput').value.trim();
  if(!val) return alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹');
  sessionKey = val.toLowerCase().replace(/[^a-z0-9\u0600-\u06ff]/g,'_');
  localStorage.setItem('lastSession', sessionKey);
  document.getElementById('sessionModal').classList.add('hidden');
  initApp();
}

async function initApp() {
  document.getElementById('loadingOverlay').classList.remove('hidden');
  try {
    const saved = await window._fbGet('projects/' + sessionKey);
    data = saved || { weeks:{}, contractorPhone:'' };
  } catch(e) {
    // fallback
    const local = localStorage.getItem('fb_backup_'+sessionKey);
    data = local ? JSON.parse(local) : { weeks:{}, contractorPhone:'' };
  }
  if(!data.contractorPhone) data.contractorPhone = '';
  document.getElementById('loadingOverlay').classList.add('hidden');
  buildWeekSelect();
  const weeks = Object.keys(data.weeks||{}).sort();
  currentWeek = weeks.length ? weeks[weeks.length-1] : null;
  if(!currentWeek) addWeek(true);
  else document.getElementById('weekSelect').value = currentWeek;
  if(data.contractorPhone) document.getElementById('contractorPhone').value = data.contractorPhone;
  renderAll(); showTab('workers');
}

// ===== WEEKS =====
function getTodaySat() {
  const d=new Date(); const diff=(d.getDay()+1)%7; d.setDate(d.getDate()-diff); return d.toISOString().slice(0,10);
}
function buildWeekSelect() {
  const sel=document.getElementById('weekSelect'); sel.innerHTML='';
  Object.keys(data.weeks||{}).sort().reverse().forEach(w=>{
    const o=document.createElement('option'); o.value=w; o.textContent='Ø£Ø³Ø¨ÙˆØ¹ '+w; sel.appendChild(o);
  });
}
function addWeek(silent=false) {
  if(!data.weeks) data.weeks={};
  const ex=Object.keys(data.weeks).sort();
  let key=!ex.length?getTodaySat():(() => { const d=new Date(ex[ex.length-1]); d.setDate(d.getDate()+7); return d.toISOString().slice(0,10); })();
  if(data.weeks[key]) return alert('Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ù…ÙˆØ¬ÙˆØ¯');
  const base = currentWeek&&data.weeks[currentWeek] ?
    data.weeks[currentWeek].workers.map(w=>({...w,days:[false,false,false,false,false,false,false],advance:0,deduction:0})) : [];
  data.weeks[key]={workers:base,loans:[],expenses:[],payments:[]};
  currentWeek=key; buildWeekSelect(); document.getElementById('weekSelect').value=key;
  if(!silent){saveData();renderAll();}
}
function loadWeek(){ currentWeek=document.getElementById('weekSelect').value; renderAll(); }
function deleteCurrentWeek(){
  if(!currentWeek||!confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ØŸ')) return;
  delete data.weeks[currentWeek];
  const w=Object.keys(data.weeks).sort(); currentWeek=w.length?w[w.length-1]:null;
  buildWeekSelect(); if(currentWeek) document.getElementById('weekSelect').value=currentWeek;
  saveData(); renderAll();
}
function week(){ return currentWeek&&data.weeks&&data.weeks[currentWeek]?data.weeks[currentWeek]:{workers:[],loans:[],expenses:[],payments:[]}; }

// ===== WORKERS =====
function addWorker(){
  const name=document.getElementById('newWorkerName').value.trim();
  const wage=parseFloat(document.getElementById('newWorkerWage').value)||0;
  const phone=document.getElementById('newWorkerPhone').value.trim();
  if(!name) return alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„');
  week().workers.push({id:Date.now(),name,wage,phone,days:[false,false,false,false,false,false,false],advance:0,deduction:0});
  ['newWorkerName','newWorkerWage','newWorkerPhone'].forEach(id=>document.getElementById(id).value='');
  saveData(); renderWorkers();
}
function toggleDay(i,di){ week().workers[i].days[di]=!week().workers[i].days[di]; saveData(); renderWorkers(); }
function updateWorkerField(i,f,v){
  week().workers[i][f]=parseFloat(v)||0;
  const el=document.getElementById('final-'+i);
  if(el) el.textContent='ğŸ’µ Ø§Ù„Ø£Ø¬Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: '+calcWorkerSalary(week().workers[i])+' Ø¯ÙŠÙ†Ø§Ø±';
  saveData();
}
function deleteWorker(i){ if(!confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø§Ù…Ù„ØŸ')) return; week().workers.splice(i,1); saveData(); renderWorkers(); }
function calcWorkerSalary(w){ return (w.days.filter(Boolean).length*w.wage)+(w.advance||0)-(w.deduction||0); }

function sendWhatsApp(i){
  const w=week().workers[i], net=calcWorkerSalary(w), cnt=w.days.filter(Boolean).length;
  const msg=`Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ${w.name} ğŸ‘·\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ“… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹: ${currentWeek}\nğŸ“† Ø§Ù„Ø­Ø¶ÙˆØ±: ${DAYS.filter((_,di)=>w.days[di]).join('ØŒ ')||'â€”'}\nğŸ”¢ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…: ${cnt}\nğŸ’° Ø§Ù„Ø£Ø¬Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ: ${w.wage} Ø¯ÙŠÙ†Ø§Ø±\n${w.advance?'â• Ø³Ù„ÙØ©: '+w.advance+' Ø¯ÙŠÙ†Ø§Ø±\n':''}${w.deduction?'â– Ø®ØµÙ…: '+w.deduction+' Ø¯ÙŠÙ†Ø§Ø±\n':''}â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ’µ Ø§Ù„Ø£Ø¬Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: ${net} Ø¯ÙŠÙ†Ø§Ø±\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\nØ¨Ø§Ø±Ùƒ Ø§Ù„Ù„Ù‡ ÙÙŠ Ø¬Ù‡ÙˆØ¯Ùƒ ÙˆØ£Ø¹Ø·Ø§Ùƒ Ø§Ù„ØµØ­Ø© ÙˆØ§Ù„Ø¹Ø§ÙÙŠØ© ğŸ‡®ğŸ‡¶`;
  window.open('https://wa.me/'+(w.phone||'').replace(/\D/g,'')+'?text='+encodeURIComponent(msg),'_blank');
}
function printWorker(i){
  const w=week().workers[i], net=calcWorkerSalary(w);
  const win=window.open('','_blank');
  win.document.write(`<html dir="rtl"><body style="font-family:Arial;padding:24px;max-width:400px"><h2 style="color:#1565C0">ÙƒØ´Ù Ø§Ù„Ø¹Ø§Ù…Ù„</h2><table style="width:100%;border-collapse:collapse;margin:12px 0"><tr><td style="padding:6px;border-bottom:1px solid #eee;color:#666">Ø§Ù„Ø§Ø³Ù…</td><td style="padding:6px;border-bottom:1px solid #eee;font-weight:700">${w.name}</td></tr><tr><td style="padding:6px;border-bottom:1px solid #eee;color:#666">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</td><td style="padding:6px;border-bottom:1px solid #eee">${currentWeek}</td></tr><tr><td style="padding:6px;border-bottom:1px solid #eee;color:#666">Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±</td><td style="padding:6px;border-bottom:1px solid #eee">${DAYS.filter((_,di)=>w.days[di]).join(' - ')||'â€”'}</td></tr><tr><td style="padding:6px;border-bottom:1px solid #eee;color:#666">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…</td><td style="padding:6px;border-bottom:1px solid #eee">${w.days.filter(Boolean).length}</td></tr><tr><td style="padding:6px;border-bottom:1px solid #eee;color:#666">Ø§Ù„Ø£Ø¬Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ</td><td style="padding:6px;border-bottom:1px solid #eee">${w.wage} Ø¯ÙŠÙ†Ø§Ø±</td></tr>${w.advance?'<tr><td style="padding:6px;border-bottom:1px solid #eee;color:#2e7d32">Ø³Ù„ÙØ©</td><td style="padding:6px;border-bottom:1px solid #eee;color:#2e7d32">+'+w.advance+' Ø¯ÙŠÙ†Ø§Ø±</td></tr>':''}${w.deduction?'<tr><td style="padding:6px;border-bottom:1px solid #eee;color:#c62828">Ø®ØµÙ…</td><td style="padding:6px;border-bottom:1px solid #eee;color:#c62828">-'+w.deduction+' Ø¯ÙŠÙ†Ø§Ø±</td></tr>':''}<tr style="background:#e8f5e9"><td style="padding:8px;font-weight:800;color:#2e7d32">Ø§Ù„Ø£Ø¬Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</td><td style="padding:8px;font-weight:800;color:#2e7d32;font-size:18px">${net} Ø¯ÙŠÙ†Ø§Ø±</td></tr></table><div style="text-align:center;color:#999;font-size:12px;margin-top:20px">Ø¨Ø§Ø±Ùƒ Ø§Ù„Ù„Ù‡ ÙÙŠ Ø¬Ù‡ÙˆØ¯Ùƒ ÙˆØ£Ø¹Ø·Ø§Ùƒ Ø§Ù„ØµØ­Ø© ÙˆØ§Ù„Ø¹Ø§ÙÙŠØ© ğŸ‡®ğŸ‡¶</div><script>window.print()<\/script></body></html>`);
}

function renderWorkers(){
  const w=week(), c=document.getElementById('workersList');
  if(!w.workers.length){c.innerHTML='<div class="empty-msg">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ø§Ù„ â€” Ø£Ø¶Ù Ø¹Ø§Ù…Ù„Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹ ğŸ‘†</div>';return;}
  c.innerHTML=w.workers.map((wk,i)=>{
    const net=calcWorkerSalary(wk);
    return `<div class="worker-card"><div class="worker-name-bar"><span>${wk.name}</span><span style="font-size:13px;color:#555">${wk.wage} Ø¯/ÙŠÙˆÙ…</span></div><div class="worker-body"><div class="days-row">${DAYS.map((d,di)=>`<button class="day-btn${wk.days[di]?' present':''}" onclick="toggleDay(${i},${di})">${d}</button>`).join('')}</div><div style="font-size:13px;color:#555;margin-bottom:8px">ğŸ“† ${wk.days.filter(Boolean).length} ÙŠÙˆÙ… Ø­Ø¶ÙˆØ±</div><div class="input-grid"><div class="input-box"><label>â• Ø³Ù„ÙØ© (Ø¯ÙŠÙ†Ø§Ø±)</label><input type="number" value="${wk.advance||0}" oninput="updateWorkerField(${i},'advance',this.value)"></div><div class="input-box"><label>â– Ø®ØµÙ… (Ø¯ÙŠÙ†Ø§Ø±)</label><input type="number" value="${wk.deduction||0}" oninput="updateWorkerField(${i},'deduction',this.value)"></div></div><div class="final-salary" id="final-${i}">ğŸ’µ Ø§Ù„Ø£Ø¬Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: ${net} Ø¯ÙŠÙ†Ø§Ø±</div><div class="worker-actions"><button class="btn btn-teal" onclick="printWorker(${i})">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button><button class="btn btn-green" onclick="sendWhatsApp(${i})">ğŸ“± ÙˆØ§ØªØ³Ø§Ø¨</button><button class="btn btn-red" onclick="deleteWorker(${i})">âŒ Ø­Ø°Ù</button></div></div></div>`;
  }).join('');
}

// ===== LOANS =====
function addLoan(){
  const a=parseFloat(document.getElementById('loanAmount').value); if(!a) return alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº');
  const ld=document.getElementById('loanDate').value; if(!ld) return alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ®');
  week().loans.push({id:Date.now(),amount:a,date:ld});
  document.getElementById('loanAmount').value=''; saveData(); renderLoans(); renderSummary();
}
function deleteLoan(i){week().loans.splice(i,1);saveData();renderLoans();renderSummary();}
function renderLoans(){
  const l=week().loans;
  document.getElementById('totalLoanBadge').textContent=l.reduce((s,x)=>s+x.amount,0)+' Ø¯ÙŠÙ†Ø§Ø±';
  document.getElementById('loansList').innerHTML=!l.length?'<div class="empty-msg">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ù„Ù</div>':
    l.map((x,i)=>`<div class="item-row"><span class="item-amount" style="color:#c62828">${x.amount} Ø¯ÙŠÙ†Ø§Ø±</span><span class="item-date">${x.date}</span><button class="delete-btn" onclick="deleteLoan(${i})">âœ•</button></div>`).join('');
}

// ===== EXPENSES =====
function addExpense(){
  const desc=document.getElementById('expDesc').value.trim(), a=parseFloat(document.getElementById('expAmount').value);
  if(!desc||!a) return alert('Ø£Ø¯Ø®Ù„ Ø§Ù„ÙˆØµÙ ÙˆØ§Ù„Ù…Ø¨Ù„Øº');
  const ed=document.getElementById('expDate').value; if(!ed) return alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ®');
  week().expenses.push({id:Date.now(),desc,amount:a,date:ed});
  document.getElementById('expDesc').value=''; document.getElementById('expAmount').value='';
  saveData(); renderExpenses(); renderSummary();
}
function deleteExpense(i){week().expenses.splice(i,1);saveData();renderExpenses();renderSummary();}
function renderExpenses(){
  const e=week().expenses;
  document.getElementById('totalExpBadge').textContent=e.reduce((s,x)=>s+x.amount,0)+' Ø¯ÙŠÙ†Ø§Ø±';
  document.getElementById('expensesList').innerHTML=!e.length?'<div class="empty-msg">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ±ÙˆÙØ§Øª</div>':
    e.map((x,i)=>`<div class="item-row"><span class="item-info">${x.desc}</span><span class="item-amount" style="color:#e65100">${x.amount} Ø¯ÙŠÙ†Ø§Ø±</span><span class="item-date">${x.date}</span><button class="delete-btn" onclick="deleteExpense(${i})">âœ•</button></div>`).join('');
}

// ===== PAYMENTS =====
function saveContractorPhone(){data.contractorPhone=document.getElementById('contractorPhone').value.trim();saveData();alert('âœ… ØªÙ… Ø­ÙØ¸ Ø±Ù‚Ù… Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„');}
function openPaymentModal(){document.getElementById('pmtAmount').value='';document.getElementById('pmtNote').value='';document.getElementById('pmtDate').value='';document.getElementById('paymentModal').classList.remove('hidden');}
function closePaymentModal(){document.getElementById('paymentModal').classList.add('hidden');}
function addPayment(){
  const a=parseFloat(document.getElementById('pmtAmount').value); if(!a) return alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº');
  const date=document.getElementById('pmtDate').value; if(!date) return alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ®'); const note=document.getElementById('pmtNote').value.trim();
  if(!week().payments) week().payments=[];
  week().payments.push({id:Date.now(),amount:a,date,note});
  const totalR=week().payments.reduce((s,p)=>s+p.amount,0);
  const w=week(), totalC=(w.workers.reduce((s,wk)=>s+calcWorkerSalary(wk),0))+(w.loans.reduce((s,l)=>s+l.amount,0))+(w.expenses.reduce((s,e)=>s+e.amount,0));
  const bal=totalR-totalC;
  saveData(); closePaymentModal(); renderPayments(); renderSummary();
  const phone=(data.contractorPhone||'').replace(/\D/g,'');
  const msg=`Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ğŸ—ï¸\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ“‹ Ø¥Ø´Ø¹Ø§Ø± Ø§Ø³ØªÙ„Ø§Ù… Ù…Ø¨Ù„Øº\nğŸ“… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹: ${currentWeek}\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ’œ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªÙ„Ù… Ø§Ù„Ø¢Ù†: ${a} Ø¯ÙŠÙ†Ø§Ø±\n${note?'ğŸ“ '+note+'\n':''}ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªÙ„Ù…: ${totalR} Ø¯ÙŠÙ†Ø§Ø±\nğŸ’¸ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ: ${totalC} Ø¯ÙŠÙ†Ø§Ø±\n${bal>=0?'âœ… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: '+bal:'âš ï¸ Ø§Ù„Ø¹Ø¬Ø²: '+Math.abs(bal)} Ø¯ÙŠÙ†Ø§Ø±\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\nØ¨Ø§Ø±Ùƒ Ø§Ù„Ù„Ù‡ ÙÙŠ Ø¬Ù‡ÙˆØ¯Ùƒ ÙˆØ£Ø¹Ø·Ø§Ùƒ Ø§Ù„ØµØ­Ø© ÙˆØ§Ù„Ø¹Ø§ÙÙŠØ© ğŸ‡®ğŸ‡¶`;
  if(phone){ if(confirm('Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ù‚Ø§ÙˆÙ„ Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨ØŸ')) window.open('https://wa.me/'+phone+'?text='+encodeURIComponent(msg),'_blank'); }
  else alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø¨Ù„Øº ÙÙŠ Firebase!\n\nØ£Ø¶Ù Ø±Ù‚Ù… Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙˆØ§ØªØ³Ø§Ø¨.');
}
function deletePayment(i){week().payments.splice(i,1);saveData();renderPayments();renderSummary();}
function renderPayments(){
  const p=week().payments||[];
  document.getElementById('totalPaymentsBadge').textContent=p.reduce((s,x)=>s+x.amount,0)+' Ø¯ÙŠÙ†Ø§Ø±';
  document.getElementById('paymentsList').innerHTML=!p.length?'<div class="empty-msg">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ù„Øº Ù…Ø³ØªÙ„Ù…Ø©</div>':
    p.map((x,i)=>`<div class="payment-item"><div><div class="p-amount">${x.amount} Ø¯ÙŠÙ†Ø§Ø±</div>${x.note?`<div class="p-note">ğŸ“ ${x.note}</div>`:''}<div class="p-date">ğŸ“… ${x.date}</div></div><button class="delete-btn" onclick="deletePayment(${i})">âœ•</button></div>`).join('');
}

// ===== EXCEL =====
function exportToExcel(){
  const wb=XLSX.utils.book_new(), w=week();
  const wRows=[['Ø§Ù„Ø§Ø³Ù…','Ø§Ù„Ø³Ø¨Øª','Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©','Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…','Ø§Ù„Ø£Ø¬Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ','Ø§Ù„Ø³Ù„ÙØ©','Ø§Ù„Ø®ØµÙ…','Ø§Ù„Ø£Ø¬Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ']];
  w.workers.forEach(wk=>{ const net=calcWorkerSalary(wk); wRows.push([wk.name,...wk.days.map(d=>d?'âœ“':'âœ—'),wk.days.filter(Boolean).length,wk.wage,wk.advance||0,wk.deduction||0,net]); });
  wRows.push([]); wRows.push(['Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ','','','','','','','',w.workers.reduce((s,wk)=>s+wk.days.filter(Boolean).length,0),'',w.workers.reduce((s,wk)=>s+(wk.advance||0),0),w.workers.reduce((s,wk)=>s+(wk.deduction||0),0),w.workers.reduce((s,wk)=>s+calcWorkerSalary(wk),0)]);
  const ws1=XLSX.utils.aoa_to_sheet(wRows); ws1['!cols']=[{wch:18},{wch:7},{wch:7},{wch:9},{wch:9},{wch:9},{wch:7},{wch:7},{wch:10},{wch:12},{wch:10},{wch:10},{wch:14}]; XLSX.utils.book_append_sheet(wb,ws1,'Ø£Ø¬ÙˆØ± Ø§Ù„Ø¹Ù…Ø§Ù„');
  const eRows=[['Ø§Ù„ÙˆØµÙ','Ø§Ù„Ù…Ø¨Ù„Øº','Ø§Ù„ØªØ§Ø±ÙŠØ®']]; w.expenses.forEach(e=>eRows.push([e.desc,e.amount,e.date])); eRows.push(['Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ',w.expenses.reduce((s,e)=>s+e.amount,0),'']); eRows.push([]); eRows.push(['Ø³Ù„ÙØ© Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„','Ø§Ù„Ù…Ø¨Ù„Øº','Ø§Ù„ØªØ§Ø±ÙŠØ®']); w.loans.forEach(l=>eRows.push(['Ø³Ù„ÙØ©',l.amount,l.date])); eRows.push(['Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ',w.loans.reduce((s,l)=>s+l.amount,0),'']);
  const ws2=XLSX.utils.aoa_to_sheet(eRows); ws2['!cols']=[{wch:25},{wch:14},{wch:14}]; XLSX.utils.book_append_sheet(wb,ws2,'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙˆØ§Ù„Ø³Ù„Ù');
  const pRows=[['Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªÙ„Ù…','Ù…Ù„Ø§Ø­Ø¸Ø©','Ø§Ù„ØªØ§Ø±ÙŠØ®']]; (w.payments||[]).forEach(p=>pRows.push([p.amount,p.note||'',p.date])); pRows.push(['Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ',(w.payments||[]).reduce((s,p)=>s+p.amount,0),'']);
  const ws3=XLSX.utils.aoa_to_sheet(pRows); ws3['!cols']=[{wch:16},{wch:25},{wch:14}]; XLSX.utils.book_append_sheet(wb,ws3,'Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©');
  const tW=w.workers.reduce((s,wk)=>s+calcWorkerSalary(wk),0), tL=w.loans.reduce((s,l)=>s+l.amount,0), tE=w.expenses.reduce((s,e)=>s+e.amount,0), tR=(w.payments||[]).reduce((s,p)=>s+p.amount,0), tC=tW+tL+tE, bal=tR-tC;
  const sRows=[['Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹',currentWeek],[],['Ø§Ù„Ø¨Ù†Ø¯','Ø§Ù„Ù…Ø¨Ù„Øº (Ø¯ÙŠÙ†Ø§Ø±)'],['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£Ø¬ÙˆØ± Ø§Ù„Ø¹Ù…Ø§Ù„',tW],['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª',tE],['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ù„Ù Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„',tL],['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ',tC],[],['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªÙ„Ù…',tR],[bal>=0?'Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ (Ø±Ø¨Ø­)':'Ø§Ù„Ø¹Ø¬Ø²',Math.abs(bal)]];
  const ws4=XLSX.utils.aoa_to_sheet(sRows); ws4['!cols']=[{wch:28},{wch:18}]; XLSX.utils.book_append_sheet(wb,ws4,'Ø§Ù„Ù…Ù„Ø®Øµ');
  XLSX.writeFile(wb,`Ø­Ø³Ø§Ø¨Ø§Øª_${currentWeek}.xlsx`);
}

// ===== SUMMARY =====
function renderSummary(){
  const w=week(), tW=w.workers.reduce((s,wk)=>s+calcWorkerSalary(wk),0), tL=w.loans.reduce((s,l)=>s+l.amount,0), tE=w.expenses.reduce((s,e)=>s+e.amount,0), tC=tW+tL+tE, tR=(w.payments||[]).reduce((s,p)=>s+p.amount,0), bal=tR-tC;
  document.getElementById('summaryContent').innerHTML=`
    <div class="action-grid">
      <button class="action-btn-big btn-excel" onclick="exportToExcel()"><span class="icon">ğŸ“Š</span><span>ØªØµØ¯ÙŠØ± Excel</span></button>
      <button class="action-btn-big btn-gray" onclick="printSummary()"><span class="icon">ğŸ–¨ï¸</span><span>Ø·Ø¨Ø§Ø¹Ø©</span></button>
      <button class="action-btn-big btn-purple" onclick="showTab('payments')"><span class="icon">ğŸ’œ</span><span>Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„</span></button>
      <button class="action-btn-big" style="background:#455a64" onclick="changeSession()"><span class="icon">ğŸ”„</span><span>ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</span></button>
    </div>
    <div class="summary-box green"><div class="summary-title">ğŸ’° Ø£Ø¬ÙˆØ± Ø§Ù„Ø¹Ù…Ø§Ù„</div>${w.workers.length?w.workers.map(wk=>`<div class="summary-row"><span>${wk.name} (${wk.days.filter(Boolean).length} ÙŠÙˆÙ…)</span><span style="color:#2e7d32;font-weight:700">${calcWorkerSalary(wk)} Ø¯ÙŠÙ†Ø§Ø±</span></div>`).join(''):'<div class="empty-msg">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ø§Ù„</div>'}<div class="summary-row"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span style="color:#2e7d32">${tW} Ø¯ÙŠÙ†Ø§Ø±</span></div></div>
    <div class="summary-box orange"><div class="summary-title">ğŸ§¾ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</div>${w.expenses.length?w.expenses.map(e=>`<div class="summary-row"><span>${e.desc}</span><span style="color:#e65100;font-weight:700">${e.amount} Ø¯ÙŠÙ†Ø§Ø±</span></div>`).join(''):'<div class="empty-msg">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ±ÙˆÙØ§Øª</div>'}<div class="summary-row"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span style="color:#e65100">${tE} Ø¯ÙŠÙ†Ø§Ø±</span></div></div>
    <div class="summary-box red"><div class="summary-title">ğŸ’µ Ø³Ù„Ù Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„</div>${w.loans.length?w.loans.map(l=>`<div class="summary-row"><span>${l.date}</span><span style="color:#c62828;font-weight:700">${l.amount} Ø¯ÙŠÙ†Ø§Ø±</span></div>`).join(''):'<div class="empty-msg">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ù„Ù</div>'}<div class="summary-row"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span style="color:#c62828">${tL} Ø¯ÙŠÙ†Ø§Ø±</span></div></div>
    <div class="summary-box purple"><div class="summary-title">ğŸ’œ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©</div>${(w.payments||[]).length?(w.payments||[]).map(p=>`<div class="summary-row"><span>${p.date}${p.note?' â€” '+p.note:''}</span><span style="color:#6a1b9a;font-weight:700">${p.amount} Ø¯ÙŠÙ†Ø§Ø±</span></div>`).join(''):'<div class="empty-msg">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ù„Øº Ù…Ø³ØªÙ„Ù…Ø©</div>'}<div class="summary-row"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span style="color:#6a1b9a">${tR} Ø¯ÙŠÙ†Ø§Ø±</span></div></div>
    <div class="summary-box blue"><div class="summary-title">ğŸ“Œ Ù…Ù„Ø®Øµ â€” ${currentWeek}</div><div class="summary-row"><span>ğŸ’° Ø£Ø¬ÙˆØ± Ø§Ù„Ø¹Ù…Ø§Ù„:</span><span>${tW} Ø¯ÙŠÙ†Ø§Ø±</span></div><div class="summary-row"><span>ğŸ§¾ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª:</span><span>${tE} Ø¯ÙŠÙ†Ø§Ø±</span></div><div class="summary-row"><span>ğŸ’µ Ø³Ù„Ù Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„:</span><span>${tL} Ø¯ÙŠÙ†Ø§Ø±</span></div><div class="summary-row"><span>ğŸ’¸ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ:</span><span style="color:#c62828;font-weight:800">${tC} Ø¯ÙŠÙ†Ø§Ø±</span></div><div class="summary-row"><span>ğŸ’œ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªÙ„Ù…:</span><span style="color:#6a1b9a">${tR} Ø¯ÙŠÙ†Ø§Ø±</span></div><div class="summary-row"><span>${bal>=0?'âœ… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ':'âš ï¸ Ø§Ù„Ø¹Ø¬Ø²'}:</span><span style="color:${bal>=0?'#2e7d32':'#c62828'};font-size:22px;font-weight:800">${Math.abs(bal)} Ø¯ÙŠÙ†Ø§Ø±</span></div></div>`;
}

function printSummary(){
  const w=week(), tW=w.workers.reduce((s,wk)=>s+calcWorkerSalary(wk),0), tL=w.loans.reduce((s,l)=>s+l.amount,0), tE=w.expenses.reduce((s,e)=>s+e.amount,0), tR=(w.payments||[]).reduce((s,p)=>s+p.amount,0), tC=tW+tL+tE, bal=tR-tC;
  const win=window.open('','_blank');
  win.document.write(`<html dir="rtl"><body style="font-family:Arial;padding:24px"><h2 style="color:#1565C0">Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ â€” ${currentWeek}</h2><h3>Ø£Ø¬ÙˆØ± Ø§Ù„Ø¹Ù…Ø§Ù„:</h3>${w.workers.map(wk=>`<p>${wk.name}: ${calcWorkerSalary(wk)} Ø¯ÙŠÙ†Ø§Ø± (${wk.days.filter(Boolean).length} ÙŠÙˆÙ…)</p>`).join('')}<p><b>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${tW} Ø¯ÙŠÙ†Ø§Ø±</b></p><h3>Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª:</h3>${w.expenses.map(e=>`<p>${e.desc}: ${e.amount} Ø¯ÙŠÙ†Ø§Ø±</p>`).join('')}<p><b>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${tE} Ø¯ÙŠÙ†Ø§Ø±</b></p><h3>Ø³Ù„Ù Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„:</h3>${w.loans.map(l=>`<p>${l.date}: ${l.amount} Ø¯ÙŠÙ†Ø§Ø±</p>`).join('')}<p><b>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${tL} Ø¯ÙŠÙ†Ø§Ø±</b></p><h3>Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©:</h3>${(w.payments||[]).map(p=>`<p>${p.date}: ${p.amount} Ø¯ÙŠÙ†Ø§Ø±${p.note?' â€” '+p.note:''}</p>`).join('')}<p><b>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${tR} Ø¯ÙŠÙ†Ø§Ø±</b></p><hr><h2 style="color:#c62828">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ: ${tC} Ø¯ÙŠÙ†Ø§Ø±</h2><h2 style="color:${bal>=0?'#2e7d32':'#c62828'}">${bal>=0?'Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ':'Ø§Ù„Ø¹Ø¬Ø²'}: ${Math.abs(bal)} Ø¯ÙŠÙ†Ø§Ø±</h2><div style="text-align:center;color:#999;margin-top:20px">Ø¨Ø§Ø±Ùƒ Ø§Ù„Ù„Ù‡ ÙÙŠ Ø¬Ù‡ÙˆØ¯Ùƒ ÙˆØ£Ø¹Ø·Ø§Ùƒ Ø§Ù„ØµØ­Ø© ÙˆØ§Ù„Ø¹Ø§ÙÙŠØ© ğŸ‡®ğŸ‡¶</div><script>window.print()<\/script></body></html>`);
}

// ===== TABS =====
function showTab(t){
  ['workers','summary','payments'].forEach(x=>{
    document.getElementById('tab-'+x+'-content').style.display=x===t?'block':'none';
    document.getElementById('tab-'+x).classList.toggle('active',x===t);
  });
  if(t==='summary') renderSummary();
  if(t==='payments') renderPayments();
}
function changeSession(){if(!confirm('ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ØŸ')) return; localStorage.removeItem('lastSession'); location.reload();}
function renderAll(){ renderWorkers(); renderLoans(); renderExpenses(); renderSummary(); renderPayments(); }
function today(){ return new Date().toISOString().slice(0,10); }

// ===== BOOT =====
document.addEventListener('DOMContentLoaded', async () => {
  // dates are manual
  const last=localStorage.getItem('lastSession');
  if(last){ sessionKey=last; document.getElementById('sessionModal').classList.add('hidden'); await initApp(); }
  else { document.getElementById('loadingOverlay').classList.add('hidden'); document.getElementById('sessionModal').classList.remove('hidden'); }
});
document.getElementById('sessionInput').addEventListener('keydown', e=>{ if(e.key==='Enter') startSession(); });

// Timeout fallback
setTimeout(()=>{
  if(document.getElementById('loadingOverlay').classList.contains('hidden')) return;
  document.getElementById('loadingOverlay').classList.add('hidden');
  document.getElementById('sessionModal').classList.remove('hidden');
},5000);
</script>

</body>
</html>
